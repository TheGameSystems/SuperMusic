<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SuperMusic - Player</title>
<style>
  :root{--bg:#071229;--card:#142033;--accent:#6ee7b7;--muted:#9aa4b2}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#07192b);color:#e6eef6;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}
  .player{width:100%;max-width:820px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03)}
  .top{display:flex;gap:14px;align-items:center}
  .art{width:120px;height:120px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#60a5fa);display:flex;align-items:center;justify-content:center;font-size:30px;font-weight:800;color:#022}
  .meta{flex:1;min-width:0}
  .title{font-weight:800;font-size:18px;margin:0}
  .artist{color:var(--muted);margin-top:6px;font-size:13px}
  .controls{display:flex;gap:10px;margin-top:12px}
  .btn{background:var(--accent);border:none;color:#022;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  .progress{height:10px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden;margin-top:12px;cursor:pointer}
  .bar{height:100%;background:linear-gradient(90deg,var(--accent),#60a5fa);width:0%}
  .time{display:flex;justify-content:space-between;color:var(--muted);font-size:13px;margin-top:6px}
  .back{display:inline-block;margin-top:12px;color:var(--accent);text-decoration:none;font-weight:700}
  #youtubeContainer iframe{width:100%;height:420px;border:0;border-radius:8px;margin-top:16px}
  .message{color:#ffcccb;margin-top:10px}
</style>
</head>
<body>
  <div class="player" role="main" aria-live="polite">
    <div class="top">
      <div class="art" id="coverArt">??</div>
      <div class="meta">
        <div class="title" id="trackTitle">Loading...</div>
        <div class="artist" id="trackArtist"></div>

        <!-- mp3 controls -->
        <div id="mp3Controls" style="margin-top:8px">
          <div class="controls">
            <button class="btn" id="playBtn">▶ Play</button>
            <button class="btn" id="stopBtn" style="background:transparent;color:#dbeeff;border:1px solid rgba(255,255,255,0.04)">Stop</button>
          </div>
          <div class="progress" id="progressBar" aria-label="seek bar" role="slider" tabindex="0">
            <div class="bar" id="progressFill"></div>
          </div>
          <div class="time"><span id="currentTime">0:00</span><span id="duration">0:00</span></div>
        </div>

        <!-- youtube placeholder (hidden until used) -->
        <div id="youtubeContainer" class="hidden"></div>
      </div>
    </div>

    <div id="message" class="message" role="status" aria-live="polite"></div>

    <a class="back" href="index.html">⬅ Back to Home</a>
  </div>

  <audio id="audio" preload="metadata"></audio>

<script>
  // parse query
  const params = new URLSearchParams(window.location.search);
  const type = params.get('type');       // 'mp3' or 'youtube'
  const url = params.get('url');         // mp3 remote URL (encoded)
  const videoId = params.get('videoId'); // youtube ID (if present)
  const source = params.get('source');   // 'session' when upload used
  const titleParam = params.get('title') || '';
  const artistParam = params.get('artist') || '';

  const titleEl = document.getElementById('trackTitle');
  const artistEl = document.getElementById('trackArtist');
  const coverEl = document.getElementById('coverArt');
  const mp3Controls = document.getElementById('mp3Controls');
  const youtubeContainer = document.getElementById('youtubeContainer');
  const messageEl = document.getElementById('message');

  titleEl.textContent = decodeURIComponent(titleParam || '') || 'Untitled';
  artistEl.textContent = decodeURIComponent(artistParam || '') || '';
  coverEl.textContent = (titleEl.textContent || '??').slice(0,2).toUpperCase();

  const audio = document.getElementById('audio');
  const playBtn = document.getElementById('playBtn');
  const stopBtn = document.getElementById('stopBtn');
  const progressBar = document.getElementById('progressBar');
  const progressFill = document.getElementById('progressFill');
  const currentTimeEl = document.getElementById('currentTime');
  const durationEl = document.getElementById('duration');

  function showMessage(txt, isError=false){
    messageEl.textContent = txt || '';
    messageEl.style.color = isError ? '#ff8b8b' : '#9aa4b2';
  }

  // ---------- MP3 flow ----------
  if(type === 'mp3'){
    // try session source first
    if(source === 'session'){
      // uploaded file was saved into sessionStorage as JSON { dataUrl, name, type }
      const raw = sessionStorage.getItem('uploadedAudio');
      if(!raw){
        showMessage('Uploaded file not found in session storage. Try re-uploading (or use the same tab).', true);
        disableMp3Controls();
      } else {
        try {
          const obj = JSON.parse(raw);
          if(!obj.dataUrl) throw new Error('invalid data');
          audio.src = obj.dataUrl;
          initMp3Controls();
          showMessage('Playing uploaded file from sessionStorage (temporary).');
        } catch (err){
          console.error(err);
          showMessage('Failed to load uploaded file: ' + err.message, true);
          disableMp3Controls();
        }
      }
    }
    // else remote url
    else if(url){
      try {
        audio.src = decodeURIComponent(url);
        initMp3Controls();
        showMessage('Loaded remote MP3.');
      } catch (err){
        console.error(err);
        showMessage('Invalid MP3 URL', true);
        disableMp3Controls();
      }
    } else {
      showMessage('No MP3 source provided', true);
      disableMp3Controls();
    }
  }

  // ---------- YouTube flow ----------
  else if(type === 'youtube'){
    mp3Controls.style.display = 'none';
    youtubeContainer.classList.remove('hidden');

    const id = videoId || params.get('url'); // accept either param name
    if(!id){
      showMessage('No YouTube video ID provided', true);
    } else {
      // Use plain embed iframe — simpler and more reliable
      const iframe = document.createElement('iframe');
      // autoplay=1 may be blocked by browser policies; playsinline=1 helps on mobile
      iframe.src = `https://www.youtube.com/embed/${encodeURIComponent(id)}?autoplay=1&controls=1&rel=0&playsinline=1`;
      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
      iframe.allowFullscreen = true;
      youtubeContainer.appendChild(iframe);
      showMessage('YouTube embed loaded. Autoplay may be blocked by browser — press play in the player if needed.');
    }
  }

  else {
    // unknown type -> show message
    mp3Controls.style.display = 'none';
    showMessage('Unknown or missing type parameter. Use index.html to open the player.', true);
  }

  // ---------- MP3 helper functions ----------
  function initMp3Controls(){
    mp3Controls.style.display = '';
    playBtn.disabled = false;
    stopBtn.disabled = false;
    updatePlayButton();
    audio.addEventListener('play', updatePlayButton);
    audio.addEventListener('pause', updatePlayButton);
    audio.addEventListener('timeupdate', onTimeUpdate);
    audio.addEventListener('loadedmetadata', () => {
      durationEl.textContent = isFinite(audio.duration) ? formatTime(audio.duration) : '0:00';
    });
    playBtn.addEventListener('click', ()=> audio.paused ? audio.play() : audio.pause());
    stopBtn.addEventListener('click', ()=> { audio.pause(); audio.currentTime = 0; });
    progressBar.addEventListener('click', (e)=> {
      const r = progressBar.getBoundingClientRect();
      const pct = (e.clientX - r.left) / r.width;
      audio.currentTime = pct * (audio.duration || 0);
    });
  }

  function disableMp3Controls(){
    mp3Controls.style.display = 'none';
    playBtn.disabled = true;
    stopBtn.disabled = true;
  }

  function updatePlayButton(){
    playBtn.textContent = audio.paused ? '▶ Play' : '⏸ Pause';
  }

  function onTimeUpdate(){
    const pct = (audio.currentTime / (audio.duration || 1)) * 100;
    progressFill.style.width = isFinite(pct) ? pct + '%' : '0%';
    currentTimeEl.textContent = formatTime(audio.currentTime || 0);
    durationEl.textContent = isFinite(audio.duration) ? formatTime(audio.duration) : '0:00';
  }

  function formatTime(s){
    s = Math.floor(s) || 0;
    return Math.floor(s/60) + ':' + String(s%60).padStart(2,'0');
  }

  // accessibility: keyboard seeking
  progressBar.addEventListener('keydown', (e) => {
    if(!audio.duration) return;
    if(e.key === 'ArrowLeft') audio.currentTime = Math.max(0, audio.currentTime - 5);
    if(e.key === 'ArrowRight') audio.currentTime = Math.min(audio.duration, audio.currentTime + 5);
  });

  // --------------- notes for developer / troubleshooting ---------------
  // If you test by opening files directly (file://...), some browsers restrict iframe/embed behavior.
  // Recommended: serve files via a local static server, e.g.:
  //   python3 -m http.server 8000
  // then open http://localhost:8000/index.html
</script>
</body>
</html>
